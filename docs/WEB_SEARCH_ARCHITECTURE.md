# Web Search Feature - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 2025-12-11
**–ê–≤—Ç–æ—Ä:** Development Team

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π](#–æ–±–∑–æ—Ä-–∏–∑–º–µ–Ω–µ–Ω–∏–π)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è)
3. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
4. [–ì—Ä–∞—Ñ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (LangGraph)](#–≥—Ä–∞—Ñ-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-langgraph)
5. [–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–¥–µ—Ç–∞–ª–∏-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
6. [–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
7. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
8. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
9. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
10. [–ú–∏–≥—Ä–∞—Ü–∏—è –∏ –¥–µ–ø–ª–æ–π](#–º–∏–≥—Ä–∞—Ü–∏—è-–∏-–¥–µ–ø–ª–æ–π)

---

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –¶–µ–ª—å —Ñ–∏—á–∏
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –∫–ª–∏–Ω–∏–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, —Ç—Ä–µ–Ω–¥—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞).

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–µ–±-–ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–∞–π—Ç–æ–≤
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
- ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è —Ä–∞–±–æ—Ç–∞ worker-–∞–≥–µ–Ω—Ç–∞ —Å –ë–î
- ‚úÖ Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –º–æ–¥—É–ª–∏
```
fastapi_app/
‚îú‚îÄ‚îÄ agent/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # —ç–∫—Å–ø–æ—Ä—Ç web_search_tool
‚îÇ   ‚îú‚îÄ‚îÄ graph.py             # routing –¥–ª—è web_search –Ω–æ–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ nodes.py             # node_web_search, –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ node_worker –∏ node_final_report
‚îÇ   ‚îú‚îÄ‚îÄ state.py             # –¥–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ enable_web_search
‚îÇ   ‚îî‚îÄ‚îÄ tools/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py      # —ç–∫—Å–ø–æ—Ä—Ç web_search_tool
‚îÇ       ‚îî‚îÄ‚îÄ web_search.py    # –ù–û–í–´–ô: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–±-–ø–æ–∏—Å–∫–∞
‚îú‚îÄ‚îÄ prompts/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # —ç–∫—Å–ø–æ—Ä—Ç web_search_prompt
‚îÇ   ‚îú‚îÄ‚îÄ system.py            # –æ–±–Ω–æ–≤–ª–µ–Ω—ã worker_sys_prompt –∏ final_report_prompt
‚îÇ   ‚îî‚îÄ‚îÄ web_search.py        # –ù–û–í–´–ô: –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
‚îî‚îÄ‚îÄ requirements.txt         # –¥–æ–±–∞–≤–ª–µ–Ω—ã trafilatura, duckduckgo-search, tenacity
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    User     ‚îÇ
‚îÇ   Request   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              LangGraph Agent                         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  enable_web_search=True?                   ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ    ‚îÇ
‚îÇ           ‚îÇ                    ‚îÇ               ‚îÇ    ‚îÇ
‚îÇ      YES  ‚îÇ                    ‚îÇ NO            ‚îÇ    ‚îÇ
‚îÇ           ‚ñº                    ‚ñº               ‚îÇ    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  node_web_search‚îÇ   ‚îÇ node_worker ‚îÇ       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ   ‚îÇ  (SQL/viz)  ‚îÇ       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ - Gen queries   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ - DuckDuckGo    ‚îÇ          ‚îÇ              ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ - Parse content ‚îÇ          ‚îÇ              ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ              ‚îÇ    ‚îÇ
‚îÇ           ‚îÇ                   ‚îÇ              ‚îÇ    ‚îÇ
‚îÇ           ‚ñº                   ‚îÇ              ‚îÇ    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ              ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  node_worker    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  (SQL/viz)      ‚îÇ                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ - Ignores web   ‚îÇ                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ   search results‚îÇ                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ - Analyzes DB   ‚îÇ                         ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îÇ    ‚îÇ
‚îÇ           ‚îÇ                                  ‚îÇ    ‚îÇ
‚îÇ           ‚ñº                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ node_final_report‚îÇ                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                  ‚îÇ                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Combines:        ‚îÇ                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 1. DB analysis   ‚îÇ                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ 2. Web insights  ‚îÇ                       ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ    ‚îÇ
‚îÇ           ‚îÇ                                  ‚îÇ    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
            ‚îÇ                                       ‚îÇ
            ‚ñº                                       ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ
    ‚îÇ Final Report ‚îÇ                               ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ
```

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –¥–∏–∑–∞–π–Ω–∞

1. **Separation of Concerns**
   - –í–µ–±-–ø–æ–∏—Å–∫ = –æ—Ç–¥–µ–ª—å–Ω–∞—è –Ω–æ–¥–∞ (–Ω–µ tool –¥–ª—è worker)
   - Worker –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ë–î, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –≤–µ–±-–¥–∞–Ω–Ω—ã–µ
   - Final report –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

2. **Fail-Safe Architecture**
   - 401/502 –æ—à–∏–±–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç –≤–µ—Å—å flow
   - Graceful fallback –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
   - Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤

3. **Context Optimization**
   - –í–µ–±-–ø–æ–∏—Å–∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –ø–æ 800 —Å–∏–º–≤–æ–ª–æ–≤
   - Final report —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞ 90% –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è 502 –æ—à–∏–±–æ–∫

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Web Search Tool (`fastapi_app/agent/tools/web_search.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–µ–±-–ø–æ–∏—Å–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
@tool(args_schema=WebSearchInput)
def web_search_tool(queries_list: List[str]) -> str:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤–µ–±-–ø–æ–∏—Å–∫ –ø–æ —Å–ø–∏—Å–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
    """

def perform_web_search(queries: List[str]) -> List[Dict[str, Any]]:
    """
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç DuckDuckGo API
    - –§–∏–ª—å—Ç—Ä—É–µ—Ç –≤–∏–¥–µ–æ-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    - –ü—Ä–∏–º–µ–Ω—è–µ—Ç retry –ª–æ–≥–∏–∫—É
    - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    """

def scrape_page_content(url: str) -> str:
    """
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç trafilatura –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
    - –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç (–±–µ–∑ HTML)
    - Timeout 10 —Å–µ–∫—É–Ω–¥
    """
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- –†–µ–≥–∏–æ–Ω –ø–æ–∏—Å–∫–∞: `ru-ru`
- –ú–∞–∫—Å–∏–º—É–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: 3
- –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞: 800 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫
- –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥: 300 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- Retry: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (2s, 4s, 10s)
- Timeout –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥: 10 —Å–µ–∫—É–Ω–¥
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π skip –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö URL

---

### 2. Web Search Node (`fastapi_app/agent/nodes.py::node_web_search`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –≤–µ–±-–ø–æ–∏—Å–∫–∞ –≤ –≥—Ä–∞—Ñ–µ LangGraph.

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:**

```python
async def node_web_search(state: AgentState, config: RunnableConfig) -> AgentState:
    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ user prompt
    user_prompt = extract_from_messages(state["messages"])

    # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ LLM
    queries = await llm.ainvoke(web_search_prompt)
    # Fallback –ø—Ä–∏ 401: skip –≤–µ–±-–ø–æ–∏—Å–∫–∞

    # 3. –í—ã–∑–æ–≤ web_search_tool
    result = await web_search_tool.ainvoke({"queries_list": queries})

    # 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ state
    return {
        "messages": [ToolMessage(
            content=result,
            tool_call_id="web_search_call",
            name="web_search_tool"  # ‚Üê –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è final_report
        )],
        "react_iter": state["react_iter"] + 1
    }
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- **401 Authentication Error**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç fallback —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
- **Timeout**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –±–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- **–ü–∞—Ä—Å–∏–Ω–≥**: Skip –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏

---

### 3. Worker Node (–æ–±–Ω–æ–≤–ª–µ–Ω)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ–º–ø—Ç–µ (`worker_sys_prompt`):**

```markdown
## –í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–±-–ø–æ–∏—Å–∫–∞ - –ò–ì–ù–û–†–ò–†–£–ô –∏—Ö
- –¢–≤–æ—è –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –∑–∞–¥–∞—á–∞ - –∞–Ω–∞–ª–∏–∑ –õ–û–ö–ê–õ–¨–ù–û–ô –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–ø–æ–ª–Ω–∏ SQL –∑–∞–ø—Ä–æ—Å—ã –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –≤–µ–±-–¥–∞–Ω–Ω—ã–µ
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ë–µ–∑ —ç—Ç–æ–≥–æ worker –≤–∏–¥–∏—Ç `ToolMessage` –æ—Ç –≤–µ–±-–ø–æ–∏—Å–∫–∞ –∏ —Å—á–∏—Ç–∞–µ—Ç –∑–∞–¥–∞—á—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π.

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
```python
try:
    response = await llm_with_tools.ainvoke([sys_prompt] + state["messages"])
except Exception as e:
    if "401" in str(e):
        return fallback_response  # Graceful degradation
    raise
```

---

### 4. Final Report Node (–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

#### –î–æ:
```python
# ‚ùå –ü—Ä–æ–±–ª–µ–º—ã:
# 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
# 2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç worker_sys_prompt ‚Üí –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
# 3. –í–µ–±-–¥–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –ø—Ä–æ–º–ø—Ç–∞
response = await llm.ainvoke([sys_prompt] + state["messages"] + [prompt])
```

#### –ü–æ—Å–ª–µ:
```python
# ‚úÖ –†–µ—à–µ–Ω–∏–µ:
# 1. –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (AIMessage, —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–µ ToolMessage)
# 2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π final_report_prompt
# 3. –í–µ–±-–¥–∞–Ω–Ω—ã–µ —è–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ user_msg

user_msg = HumanMessage(content=f"""
–í–æ–ø—Ä–æ—Å: {user_question}

## –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞:
{history_summary}  # ‚Üê SQL –∑–∞–ø—Ä–æ—Å—ã, –≥—Ä–∞—Ñ–∏–∫–∏, —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–±-–ø–æ–∏—Å–∫–∞:
{web_context}  # ‚Üê –î–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

–°–æ–∑–¥–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç.
""")

response = await llm.ainvoke([sys_prompt, user_msg])
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á–µ—Ç–∞:**

```markdown
# [–ó–∞–≥–æ–ª–æ–≤–æ–∫]

## –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑
–ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –∫–ª–∏–Ω–∏–∫–∏:
- [–í—ã–≤–æ–¥—ã –∏–∑ SQL]
- [–ê–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∏–∫–æ–≤]

## –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω—Å–∞–π—Ç
–°–æ–≥–ª–∞—Å–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º:
- [–î–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞]
- [–ò—Å—Ç–æ—á–Ω–∏–∫–∏]
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- **401**: Fallback –æ—Ç–≤–µ—Ç —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- **502**: Retry 3 —Ä–∞–∑–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 2s, 4s, 6s
- **400 (message order)**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ reraise

---

## –ì—Ä–∞—Ñ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (LangGraph)

### Routing Logic

**–§–∞–π–ª:** `fastapi_app/agent/graph.py`

```python
def route_start(state: AgentState) -> str:
    if state.get("enable_web_search", True):
        return "web_search"
    else:
        return "worker"

builder.add_conditional_edges(
    START,
    route_start,
    {
        "web_search": "web_search",
        "worker": "worker"
    }
)
```

### –ì—Ä–∞—Ñ —Å enable_web_search=True

```
START
  ‚îÇ
  ‚îú‚îÄ(enable_web_search=True)‚îÄ‚Üí web_search
  ‚îÇ                                 ‚îÇ
  ‚îÇ                                 ‚îú‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã (LLM)
  ‚îÇ                                 ‚îú‚îÄ –í—ã–ø–æ–ª–Ω—è–µ—Ç DuckDuckGo –ø–æ–∏—Å–∫
  ‚îÇ                                 ‚îú‚îÄ –ü–∞—Ä—Å–∏—Ç —Ç–æ–ø-3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞
  ‚îÇ                                 ‚îî‚îÄ –î–æ–±–∞–≤–ª—è–µ—Ç ToolMessage(name="web_search_tool")
  ‚îÇ                                 ‚îÇ
  ‚îÇ                                 ‚ñº
  ‚îî‚îÄ(enable_web_search=False)‚îÄ‚Üí worker
                                    ‚îÇ
                                    ‚îú‚îÄ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –≤–µ–±-–¥–∞–Ω–Ω—ã–µ (–ø—Ä–æ–º–ø—Ç)
                                    ‚îú‚îÄ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ë–î
                                    ‚îú‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç execute_sql_tool
                                    ‚îî‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç plot_chart_tool
                                    ‚îÇ
                                    ‚ñº
                              conditional_tools
                                    ‚îÇ
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ                     ‚îÇ
                    tool_calls?            no tool_calls
                         ‚îÇ                     ‚îÇ
                         ‚ñº                     ‚ñº
                      tools ‚îÄ‚îÄ‚îê          final_report
                              ‚îÇ                ‚îÇ
                              ‚îî‚îÄ‚Üí worker        ‚îÇ
                                                ‚ñº
                                              END
```

### State Management

**–§–∞–π–ª:** `fastapi_app/agent/state.py`

```python
class AgentState(TypedDict):
    messages: Annotated[list[AnyMessage], add_messages]
    react_iter: int
    react_max_iter: int
    charts: list[str]
    tables: list[str]
    input_tokens: int
    output_tokens: int
    total_cost: float
    enable_web_search: bool  # ‚Üê –ù–û–í–û–ï: —Ñ–ª–∞–≥ –¥–ª—è –≤–µ–±-–ø–æ–∏—Å–∫–∞
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –ü—Ä–∏ –≤—ã–∑–æ–≤–µ –≥—Ä–∞—Ñ–∞
result = await graph.ainvoke({
    "messages": [HumanMessage(content="–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")],
    "enable_web_search": True,  # ‚Üê –í–∫–ª—é—á–∏—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫
    "react_max_iter": 10
})
```

---

## –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–º–ø—Ç—ã

#### 1. Web Search Prompt (`fastapi_app/prompts/web_search.py`)

```python
web_search_prompt = ChatPromptTemplate.from_messages([
    ("system", """–í—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫-–ø–æ–∏—Å–∫–æ–≤–∏–∫...
    - –ó–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –†–û–í–ù–û {questions_count}
    - –ó–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏
    """),
    ("human", "–°–∞–º –∑–∞–ø—Ä–æ—Å = {question}")
])
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –ª–µ—á–µ–Ω–∏—è –¥–∏–∞–±–µ—Ç–∞ 2 —Ç–∏–ø–∞ –≤ –†–æ—Å—Å–∏–∏ 2024
–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–µ–ª–µ–º–µ–¥–∏—Ü–∏–Ω—ã –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–∏–∞–±–µ—Ç–æ–º
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–±–æ–ª–µ–≤–∞–µ–º–æ—Å—Ç–∏ –¥–∏–∞–±–µ—Ç–æ–º –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
```

#### 2. Worker System Prompt (–æ–±–Ω–æ–≤–ª–µ–Ω)

**–ö–ª—é—á–µ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ:**
```markdown
## –í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–±-–ø–æ–∏—Å–∫–∞ - –ò–ì–ù–û–†–ò–†–£–ô –∏—Ö
- –¢–≤–æ—è –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –∑–∞–¥–∞—á–∞ - –∞–Ω–∞–ª–∏–∑ –õ–û–ö–ê–õ–¨–ù–û–ô –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–ø–æ–ª–Ω–∏ SQL –∑–∞–ø—Ä–æ—Å—ã –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
```

#### 3. Final Report Prompt (–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω)

**–î–æ:**
```python
# –°–æ–¥–µ—Ä–∂–∞–ª –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã {question} –∏ {context} –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
final_report_prompt = """...
("human", f"–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {question}...")
"""
```

**–ü–æ—Å–ª–µ:**
```python
# –ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ–∑ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
final_report_prompt = """–¢—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫...

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á–µ—Ç–∞:
### 1. –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- –ê–Ω–∞–ª–∏–∑ –ë–î
- –ò–Ω—Å–∞–π—Ç—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö

### 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω—Å–∞–π—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å –≤–µ–±-–¥–∞–Ω–Ω—ã–µ)
- –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
- –ò—Å—Ç–æ—á–Ω–∏–∫–∏
"""
```

---

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ final_report –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ 502 (–∫–æ–Ω—Ç–µ–∫—Å—Ç 30k-50k —Ç–æ–∫–µ–Ω–æ–≤).

**–†–µ—à–µ–Ω–∏–µ:**

#### 1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```python
def filter_relevant_messages(messages):
    """–ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    relevant_content = []
    for msg in messages:
        # –¢–æ–ª—å–∫–æ AIMessage –±–µ–∑ tool_calls (—Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞)
        if isinstance(msg, AIMessage) and not msg.tool_calls:
            relevant_content.append(f"–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞: {msg.content}")

        # –¢–æ–ª—å–∫–æ ToolMessage –Ω–µ –æ—Ç –≤–µ–±-–ø–æ–∏—Å–∫–∞ (SQL —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
        elif isinstance(msg, ToolMessage) and msg.name != "web_search_tool":
            # –°–æ–∫—Ä–∞—â–∞–µ–º –¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤
            content = msg.content[:1000] if len(msg.content) > 1000 else msg.content
            relevant_content.append(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {content}")

    return "\n\n".join(relevant_content)
```

#### 2. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –≤–µ–±-–¥–∞–Ω–Ω—ã—Ö

```python
# web_search_tool
results[:3]  # –¢–æ–ª—å–∫–æ 3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–±—ã–ª–æ 5)
content[:800]  # 800 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ (–±—ã–ª–æ 2000)
snippet[:300]  # 300 –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –≤—ã–≤–æ–¥–µ (–±—ã–ª–æ 500)
```

#### 3. –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞

```python
# –í–º–µ—Å—Ç–æ: [sys_prompt] + all_messages + [final_prompt]
# –ò—Å–ø–æ–ª—å–∑—É–µ–º: [sys_prompt] + [filtered_user_msg]

[
    SystemMessage(final_report_prompt),
    HumanMessage(f"–í–æ–ø—Ä–æ—Å: {q}\n–ò—Å—Ç–æ—Ä–∏—è: {summary}\n–í–µ–±: {web}")
]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë—ã–ª–æ: 30k-50k —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí 502 error
- –°—Ç–∞–ª–æ: ~3k-5k —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤ 10 —Ä–∞–∑!**

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –ù–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–§–∞–π–ª:** `fastapi_app/requirements.txt`

```txt
# Web Search (–ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø)
trafilatura==1.12.2        # –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü
duckduckgo-search==7.0.2   # DuckDuckGo API –¥–ª—è –ø–æ–∏—Å–∫–∞
tenacity==9.0.0            # Retry –ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

# LangChain & OpenAI (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
langchain-community==1.0.5  # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
```

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞

#### trafilatura
- ‚úÖ –õ—É—á—à–∏–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã, –º–µ–Ω—é, —Ñ—É—Ç–µ—Ä–æ–≤
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ timeout –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚ùå –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: BeautifulSoup (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞), newspaper3k (–∑–∞–±—Ä–æ—à–µ–Ω)

#### duckduckgo-search
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–µ–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚ùå –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: SerpAPI (–ø–ª–∞—Ç–Ω—ã–π), Google Custom Search (–ª–∏–º–∏—Ç—ã)

#### tenacity
- ‚úÖ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è retry –ª–æ–≥–∏–∫–∏
- ‚úÖ –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫
- ‚úÖ Async support
- ‚ùå –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: backoff (–º–µ–Ω—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π)

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

#### 1. 401 Authentication Error

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π API –∫–ª—é—á –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞ OpenRouter.

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** Graceful degradation - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –±–µ–∑ –ø—Ä–æ–±–ª–µ–º–Ω–æ–π —á–∞—Å—Ç–∏.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# node_web_search
if "401" in error_str:
    logger.warning("–í–µ–±-–ø–æ–∏—Å–∫ –ø—Ä–æ–ø—É—â–µ–Ω (401)")
    return ToolMessage("–í–µ–±-–ø–æ–∏—Å–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∞—é –∞–Ω–∞–ª–∏–∑ –ë–î.")

# node_worker
if "401" in error_str:
    return AIMessage("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á.")

# node_final_report
if "401" in error_str:
    return AIMessage("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ OpenRouter.")
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:**
- –í–µ–±-–ø–æ–∏—Å–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å –ë–î
- Worker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é –æ—à–∏–±–∫—É
- Final report –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí fallback —Å–æ–æ–±—â–µ–Ω–∏–µ

#### 2. 502 Internal Server Error

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å (—á–∞—Å—Ç–æ –∏–∑-–∑–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞).

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
max_retries = 3
retry_delay = 2

for attempt in range(max_retries):
    try:
        response = await llm.ainvoke(messages)
        break
    except Exception as e:
        if "502" in str(e):
            if attempt < max_retries - 1:
                await asyncio.sleep(retry_delay * (attempt + 1))  # 2s, 4s, 6s
                continue
        raise

else:
    # –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
    return fallback_response
```

#### 3. 400 Bad Request (Message Order)

**–ü—Ä–∏—á–∏–Ω–∞:** Mistral –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `ToolMessage` —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `SystemMessage`.

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –≤ `HumanMessage`.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# ‚ùå –ë—ã–ª–æ: [SystemMessage, ToolMessage, AIMessage] ‚Üí 400 error
# ‚úÖ –°—Ç–∞–ª–æ: [SystemMessage, HumanMessage("–ò—Å—Ç–æ—Ä–∏—è: ...\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ...")]

user_msg = HumanMessage(content=f"""
–í–æ–ø—Ä–æ—Å: {question}
–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞: {summary}
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–±-–ø–æ–∏—Å–∫–∞: {web_context}
""")

response = await llm.ainvoke([sys_prompt, user_msg])
```

#### 4. Timeout / Network Errors

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** Retry –≤ `perform_web_search`, skip –≤ `scrape_page_content`.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
    retry=retry_if_exception_type((TimeoutError, RuntimeError, ConnectionError))
)
def safe_search(query: str):
    with DDGS() as ddgs:
        return ddgs.text(query, region="ru-ru", max_results=2)

# –ü–∞—Ä—Å–∏–Ω–≥ —Å timeout
config = trafilatura.settings.use_config()
config.set("DEFAULT", "EXTRACTION_TIMEOUT", "10")
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

**DuckDuckGo –ø–æ–∏—Å–∫:**
```python
# –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è rate limits)
for query in queries:
    results = safe_search(query)
    time.sleep(1.5)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
```

**–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:**
```python
# –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞
# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å ThreadPoolExecutor (future improvement)
```

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ).

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è production:**
```python
# –î–æ–±–∞–≤–∏—Ç—å Redis –∫—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–µ–±-–ø–æ–∏—Å–∫–∞
@cache(ttl=3600)  # 1 —á–∞—Å
async def get_web_search_results(query: str):
    ...
```

### 3. –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –í–µ–±-–ø–æ–∏—Å–∫: 3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞ √ó 300 —Å–∏–º–≤–æ–ª–æ–≤ = ~900 —Å–∏–º–≤–æ–ª–æ–≤
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: —Ç–æ–ª—å–∫–æ AIMessage + —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–µ ToolMessage
- –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç: –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**–ú–µ—Ç—Ä–∏–∫–∏:**
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|-----------|----------------|-------|-----------|
| –í–µ–±-–¥–∞–Ω–Ω—ã–µ | 10000 —Å–∏–º–≤–æ–ª–æ–≤ | 900 | 11x |
| –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π | 20000 —Å–∏–º–≤–æ–ª–æ–≤ | 2000 | 10x |
| –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç | 1500 —Ç–æ–∫–µ–Ω–æ–≤ | 500 | 3x |
| **–ò—Ç–æ–≥–æ** | **~50k —Ç–æ–∫–µ–Ω–æ–≤** | **~3k —Ç–æ–∫–µ–Ω–æ–≤** | **~17x** |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_web_search_tool.py` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å)

```python
import pytest
from fastapi_app.agent.tools.web_search import web_search_tool, perform_web_search

def test_web_search_tool_basic():
    """–¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞"""
    result = web_search_tool.invoke({"queries_list": ["—Ç–µ—Å—Ç –º–µ–¥–∏—Ü–∏–Ω–∞"]})
    assert "–ò—Å—Ç–æ—á–Ω–∏–∫:" in result or "–ù–µ –Ω–∞–π–¥–µ–Ω–æ" in result

def test_web_search_video_filtering():
    """–¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ-–ø–ª–∞—Ç—Ñ–æ—Ä–º"""
    results = perform_web_search(["–º–µ–¥–∏—Ü–∏–Ω–∞"])
    for res in results:
        assert "youtube.com" not in res["url"]
        assert "rutube.ru" not in res["url"]

@pytest.mark.asyncio
async def test_node_web_search_401_handling():
    """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ 401 –æ—à–∏–±–∫–∏"""
    # Mock LLM —Å 401 –æ—à–∏–±–∫–æ–π
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è fallback —Å–æ–æ–±—â–µ–Ω–∏–µ
    ...
```

### Integration —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_web_search_integration.py`

```python
@pytest.mark.asyncio
async def test_full_flow_with_web_search():
    """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow —Å –≤–µ–±-–ø–æ–∏—Å–∫–æ–º"""
    graph, _ = build_agent_graph()

    result = await graph.ainvoke({
        "messages": [HumanMessage(content="–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –ª–µ—á–µ–Ω–∏—è –¥–∏–∞–±–µ—Ç–∞")],
        "enable_web_search": True,
        "react_max_iter": 5
    })

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–±-–ø–æ–∏—Å–∫–∞
    web_search_found = any(
        isinstance(msg, ToolMessage) and msg.name == "web_search_tool"
        for msg in result["messages"]
    )
    assert web_search_found

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–∞ —Ä–∞–∑–¥–µ–ª–∞
    final_message = result["messages"][-1].content
    assert "–û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑" in final_message or "–∏–Ω—Å–∞–π—Ç" in final_message.lower()
```

### Manual —Ç–µ—Å—Ç—ã

**–ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è QA:**

- [ ] –í–µ–±-–ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å `enable_web_search=True`
- [ ] –í–µ–±-–ø–æ–∏—Å–∫ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å `enable_web_search=False`
- [ ] Worker –≤—ã–∑—ã–≤–∞–µ—Ç SQL tools –ø–æ—Å–ª–µ –≤–µ–±-–ø–æ–∏—Å–∫–∞
- [ ] Final report —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–∞ —Ä–∞–∑–¥–µ–ª–∞ (–ë–î + –≤–µ–±)
- [ ] 401 –æ—à–∏–±–∫–∞ –Ω–µ –ª–æ–º–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É
- [ ] 502 –æ—à–∏–±–∫–∞ retry 3 —Ä–∞–∑–∞
- [ ] –§–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –≤–∏–¥–µ–æ-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- [ ] –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω (<5k —Ç–æ–∫–µ–Ω–æ–≤)

---

## –ú–∏–≥—Ä–∞—Ü–∏—è –∏ –¥–µ–ø–ª–æ–π

### –®–∞–≥–∏ –¥–ª—è –¥–µ–ø–ª–æ—è

#### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –í Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
pip install -r fastapi_app/requirements.txt

# –ò–ª–∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
docker-compose build fastapi
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `.env`

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
OPENROUTER_API_KEY=sk-or-v1-...

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥–µ–ª—å
MODEL_NAME=mistralai/ministral-14b-2512

# (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –í–∫–ª—é—á–∏—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
# –í –∫–æ–¥–µ: enable_web_search=True
```

#### 3. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

**–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.** –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ –∫–æ–¥–µ –∞–≥–µ–Ω—Ç–∞, —Å—Ö–µ–º–∞ –ë–î –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç–∞.

#### 4. –û—Ç–∫–∞—Ç (rollback plan)

```bash
# –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ç–∫—É
git checkout main
docker-compose restart fastapi

# –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥
# –í –∫–æ–¥–µ: enable_web_search=False (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**

1. **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫–∞:**
   ```python
   # –í LangSmith/–ª–æ–≥–∞—Ö
   web_search_success_rate = success / total_requests
   ```

2. **–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
   ```python
   # –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å input_tokens –≤ final_report
   if input_tokens > 10000:
       alert("–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π!")
   ```

3. **–ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫:**
   ```python
   # 401, 502 –æ—à–∏–±–∫–∏ –ø–æ –Ω–æ–¥–∞–º
   error_rate_by_node = {
       "web_search": 401_count / total,
       "worker": 401_count / total,
       "final_report": 502_count / total
   }
   ```

4. **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
   ```python
   # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã
   avg_web_search_time = sum(times) / len(times)
   ```

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** DuckDuckGo –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VPN/–ø—Ä–æ–∫—Å–∏
- Fallback –Ω–∞ –¥—Ä—É–≥–æ–π –ø–æ–∏—Å–∫–æ–≤–∏–∫ (SerpAPI, Google Custom Search)

### 2. –ö–∞—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Å–∏–Ω–≥–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ —Å–∞–π—Ç—ã –ø–∞—Ä—Å—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–æ—Å–æ–±–µ–Ω–Ω–æ SPA —Å JavaScript).

**–†–µ—à–µ–Ω–∏–µ:**
- trafilatura —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å HTML
- –î–ª—è SPA –Ω—É–∂–µ–Ω Selenium/Playwright (—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ)
- –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∏–¥–µ–æ-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

### 3. Rate Limits

**–ü—Ä–æ–±–ª–µ–º–∞:** DuckDuckGo –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –ó–∞–¥–µ—Ä–∂–∫–∞ 1.5s –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- Retry –ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### 4. –°—Ç–æ–∏–º–æ—Å—Ç—å LLM

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—à–µ–≤—É—é –º–æ–¥–µ–ª—å (haiku, ministral)
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥

---

## Roadmap (–±—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è)

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 —Å–ø—Ä–∏–Ω—Ç–∞)

- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–µ–±-–ø–æ–∏—Å–∫–∞ (Redis)
- [ ] Metrics –∏ dashboards –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] Unit/Integration —Ç–µ—Å—Ç—ã
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ environment variables (`WEB_SEARCH_MAX_RESULTS`, `WEB_SEARCH_REGION`)

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (3-6 –º–µ—Å—è—Ü–µ–≤)

- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤ (Google, Bing)
- [ ] –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (semantic search)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–µ–±-–ø–æ–∏—Å–∫–∞ (LLM —Ä–µ—à–∞–µ—Ç)
- [ ] Streaming —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–µ–±-–ø–æ–∏—Å–∫–∞ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å)

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (6+ –º–µ—Å—è—Ü–µ–≤)

- [ ] RAG —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ–±-–ø–æ–∏—Å–∫–∞
- [ ] Fine-tuning –º–æ–¥–µ–ª–∏ –¥–ª—è –ª—É—á—à–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö (PubMed, ClinicalTrials.gov)
- [ ] –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

---

## FAQ

### Q: –ü–æ—á–µ–º—É –≤–µ–±-–ø–æ–∏—Å–∫ - –æ—Ç–¥–µ–ª—å–Ω–∞—è –Ω–æ–¥–∞, –∞ –Ω–µ tool –¥–ª—è worker?

**A:** –¢—Ä–∏ –ø—Ä–∏—á–∏–Ω—ã:
1. **–ö–æ–Ω—Ç—Ä–æ–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** –ù–æ–¥–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –û–î–ò–ù –≤—ã–∑–æ–≤ –≤ –Ω–∞—á–∞–ª–µ. Tool –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω worker –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ.
2. **–ò–∑–æ–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:** Worker —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ë–î, –Ω–µ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç—Å—è –Ω–∞ –≤–µ–±-–¥–∞–Ω–Ω—ã–µ.
3. **–£–ø—Ä–æ—â–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞:** Worker –Ω–µ –Ω—É–∂–Ω–æ —Ä–µ—à–∞—Ç—å, –∫–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫.

### Q: –ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º Google Search API?

**A:**
- Google Custom Search –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç—ã (100 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- DuckDuckGo –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏ –±–µ–∑ –∫–ª—é—á–µ–π
- –î–ª—è production –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ Google

### Q: –ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞?

**A:**
```python
result = await graph.ainvoke({
    "messages": [HumanMessage(content="–í–æ–ø—Ä–æ—Å")],
    "enable_web_search": False,  # ‚Üê –û—Ç–∫–ª—é—á–∏—Ç—å
    "react_max_iter": 10
})
```

### Q: –ü–æ—á–µ–º—É final_report –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç worker_sys_prompt?

**A:** worker_sys_prompt —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (database_prompt, –ø—Ä–∞–≤–∏–ª–∞ SQL). –í final_report —ç—Ç–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π final_report_prompt.

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –≤–µ–±-–ø–æ–∏—Å–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?

**A:**
1. –£–ª—É—á—à–∏—Ç—å web_search_prompt (–¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –∏ —è–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
3. –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (semantic similarity)

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–í–æ–ø—Ä–æ—Å—ã –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:**
- –°–æ–∑–¥–∞—Ç—å issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- Slack: #ai-med-brat-dev

**–ë–∞–≥–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã:**
- GitHub Issues: https://github.com/your-org/ai-med-brat/issues
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: P0 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ), P1 (–≤–∞–∂–Ω—ã–µ), P2 (—É–ª—É—á—à–µ–Ω–∏—è)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- –û—Å–Ω–æ–≤–Ω–æ–π README: `/README.md`
- API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `/docs/API.md`
- –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `/docs/WEB_SEARCH_ARCHITECTURE.md`

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-11
**–ê–≤—Ç–æ—Ä:** AI Medical BRAT Development Team
