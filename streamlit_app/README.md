# 🏥 Medical Analytics Agent - Streamlit Frontend

Веб-интерфейс для взаимодействия с медицинским аналитическим агентом.

## 🎯 Функциональность

### Основные возможности
- 💬 **Чат-интерфейс** - интуитивный диалог с агентом
- 🔍 **Автоматическая валидация** - проверка запросов перед выполнением
- 🤔 **Умные уточнения** - варианты конкретизации запросов
- 📊 **Визуализация** - автоматическое отображение графиков из S3
- 📜 **История чата** - сохранение всех сообщений в сессии
- 🔌 **Мониторинг** - проверка статуса всех сервисов

### Интеграция с бекендом

Фронтенд работает через два HTTP эндпоинта:

#### 1. POST /clarify
Проверяет запрос пользователя:
- Валидация запроса
- Определение необходимости уточнений
- Предложение вариантов конкретизации

#### 2. POST /execute
Выполняет анализ данных:
- SQL запросы к PostgreSQL
- Построение графиков
- Загрузка изображений в MinIO/S3
- Возврат результатов с S3 URLs

## 🚀 Запуск

### С Docker Compose (рекомендуется)

```bash
cd ai-med-brat
docker compose up -d
```

Приложение будет доступно по адресу: **http://localhost:8501**

### Локальный запуск

```bash
cd streamlit_app
pip install -r requirements.txt
streamlit run app.py
```

Убедитесь, что FastAPI запущен на `http://localhost:8000`

## 📋 Требования

### Environment Variables

```env
API_URL=http://fastapi:8000  # URL FastAPI бекенда
```

В Docker Compose эта переменная устанавливается автоматически.

### Зависимости

```
streamlit==1.51.0
requests==2.32.5
python-dotenv==1.1.1
```

## 🎨 Интерфейс

### Главная страница

```
┌─────────────────────────────────────┐
│  🏥 MEDBRAT.AI                      │
│  Задавайте вопросы о медицинских    │
│  данных и получайте аналитику       │
├─────────────────────────────────────┤
│                                     │
│  💬 Чат                             │
│  ┌───────────────────────────────┐  │
│  │ 👤 User: Топ-5 заболеваний    │  │
│  │ 🤖 Bot: [Результаты анализа]  │  │
│  │        📊 [График]            │  │
│  └───────────────────────────────┘  │
│                                     │
│  Ваш вопрос:                        │
│  [____________________________]     │
│  [📤 Отправить]                     │
└─────────────────────────────────────┘
```

### Sidebar

```
┌───────────────────────┐
│ 📊 Информация         │
│ [🔄 Очистить историю] │
├───────────────────────┤
│ 🔌 Статус сервисов    │
│ ✅ FastAPI: Доступен  │
│ ✅ PostgreSQL: ОК     │
│ ✅ MinIO: ОК          │
├───────────────────────┤
│ 💡 Примеры запросов   │
│ • Топ-5 заболеваний   │
│ • Средняя стоимость   │
│ • Распределение       │
└───────────────────────┘
```

## 🔄 Пользовательский флоу

### Сценарий 1: Прямое выполнение (запрос понятен)

```
1. User: "Топ-5 заболеваний в Санкт-Петербурге"
   ↓
2. Frontend → POST /clarify
   ← is_request_valid=true, needs_clarification=false
   ↓
3. Frontend → POST /execute
   ← result + charts[]
   ↓
4. Отображение результата с графиками
```

### Сценарий 2: Требуются уточнения

```
1. User: "Топ заболеваний"
   ↓
2. Frontend → POST /clarify
   ← is_request_valid=true, needs_clarification=true
   ← suggestions: [вариант1, вариант2, вариант3]
   ↓
3. Отображение вариантов уточнения
   ↓
4. User выбирает: "Топ-5 заболеваний в СПб"
   ↓
5. Frontend → POST /execute
   ← result + charts[]
   ↓
6. Отображение результата
```

### Сценарий 3: Невалидный запрос

```
1. User: "Какая погода сегодня?"
   ↓
2. Frontend → POST /clarify
   ← is_request_valid=false
   ← message="Запрос не относится к медицинским данным"
   ↓
3. Отображение ошибки
```

## 📊 Отображение графиков

Графики загружаются напрямую из MinIO S3:

### S3 URL (основной путь)
```python
charts = ["http://localhost:9000/charts/plot_abc123.png"]
st.image("http://localhost:9000/charts/plot_abc123.png")
```

### Локальный fallback (если S3 недоступен)
```python
charts = ["/charts/plot_abc123.png"]
st.image("http://localhost:8000/charts/plot_abc123.png")
```

## 🎯 Примеры запросов

### Статистика пациентов
```
"Сколько пациентов в базе данных?"
"Распределение пациентов по полу"
"Средний возраст пациентов в Санкт-Петербурге"
```

### Анализ заболеваний
```
"Топ-5 заболеваний в Санкт-Петербурге"
"Какие заболевания чаще встречаются у мужчин?"
"Динамика заболеваний по месяцам"
```

### Анализ препаратов
```
"Средняя стоимость лекарств по районам"
"Какие препараты чаще всего назначают при гипертонии?"
"Топ-10 самых дорогих препаратов"
```

### Территориальный анализ
```
"Сравнить заболеваемость между центральными и периферийными районами"
"Какой район лидирует по назначениям?"
"Распределение диагнозов по регионам"
```

## 🐛 Troubleshooting

### Проблема: "❌ Нет соединения с API"

**Причина**: FastAPI сервис недоступен

**Решение**:
```bash
# Проверить статус контейнера
docker compose ps

# Проверить логи
docker compose logs fastapi

# Перезапустить
docker compose restart fastapi
```

### Проблема: "Не удалось загрузить график"

**Причина**: MinIO недоступен или неверный URL

**Решение**:
```bash
# Проверить MinIO
docker compose logs minio

# Проверить health
curl http://localhost:8000/health

# Убедиться что порт 9000 открыт
curl http://localhost:9000/minio/health/live
```

### Проблема: "⏳ API не отвечает"

**Причина**: Запрос слишком долго выполняется

**Решение**:
- Упростить запрос
- Увеличить timeout в коде (по умолчанию 120 сек для /execute)
- Проверить нагрузку на PostgreSQL

### Проблема: Streamlit зависает на "Running..."

**Причина**: Ошибка в коде или бесконечный цикл

**Решение**:
```bash
# Посмотреть логи
docker compose logs streamlit

# Перезапустить
docker compose restart streamlit
```

## 🔧 Настройка

### Изменить порт Streamlit

В `docker-compose.yml`:
```yaml
streamlit:
  ports:
    - "8080:8501"  # Изменить 8501 на 8080
```

### Изменить API URL для разработки

В `.env`:
```env
API_URL=http://localhost:8000
```

Или в `app.py`:
```python
API_URL = os.getenv("API_URL", "http://192.168.1.100:8000")
```

### Изменить timeout

В `app.py`:
```python
def execute_query(query: str):
    response = requests.post(
        f"{API_URL}/execute",
        json={"query": query},
        timeout=300  # Увеличить с 120 до 300
    )
```

## 📚 Дополнительная документация

- [FastAPI Backend](../fastapi_app/README.md)
- [S3 Integration](../fastapi_app/S3_INTEGRATION.md)
- [Streamlit Docs](https://docs.streamlit.io/)

## ✨ Возможные улучшения

- [ ] Добавить экспорт истории чата в PDF
- [ ] Сохранение избранных запросов
- [ ] Темная тема
- [ ] Поддержка загрузки файлов
- [ ] Голосовой ввод
- [ ] Автодополнение запросов
- [ ] Sharing ссылок на результаты
