# Medical Analytics Agent API

–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å –¥–≤—É–º—è –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
fastapi_app/
‚îú‚îÄ‚îÄ main.py              # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ endpoints)
‚îú‚îÄ‚îÄ requirements.txt     # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ Dockerfile          # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ test_client.py      # –¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ agent/              # –ê–≥–µ–Ω—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py     # –≠–∫—Å–ø–æ—Ä—Ç—ã –º–æ–¥—É–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ agents.py       # –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å MedicalAnalyticsAgent
‚îÇ   ‚îú‚îÄ‚îÄ models.py       # Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è API
‚îÇ   ‚îú‚îÄ‚îÄ prompts.py      # –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è LLM
‚îÇ   ‚îî‚îÄ‚îÄ tools.py        # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (SQL, –≥—Ä–∞—Ñ–∏–∫–∏)
‚îî‚îÄ‚îÄ charts/             # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**main.py** - —Ç–æ–ª—å–∫–æ HTTP —Å–µ—Ä–≤–µ—Ä:
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è FastAPI
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ endpoints
- –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ API

**agent/** - —Ç–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞:
- `agents.py` - –∫–ª–∞—Å—Å `MedicalAnalyticsAgent` —Å –º–µ—Ç–æ–¥–∞–º–∏ `clarify_query()` –∏ `execute_query()`
- `models.py` - Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- `prompts.py` - –≤—Å–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è LLM
- `tools.py` - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π

### –î–≤–∞ HTTP —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:

1. **POST /clarify** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω—ã –ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã —É—Ç–æ—á–Ω–µ–Ω–∏–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

2. **POST /execute** - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç SQL –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   - –°—Ç—Ä–æ–∏—Ç –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:

```env
# LLM Configuration
OPENROUTER_API_KEY=your_api_key_here
API_BASE_URL=https://openrouter.ai/api/v1
MODEL_NAME=anthropic/claude-3.5-sonnet

# Database
DATABASE_URL=postgresql://meduser:medpass@localhost:5432/meddata
```

### 3. –ó–∞–ø—É—Å–∫

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
python main.py

# –ò–ª–∏ —á–µ—Ä–µ–∑ Docker
docker compose up --build
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
python test_client_v2.py
```

## API –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–æ—Å–∞

```bash
curl -X POST http://localhost:8000/clarify \
  -H "Content-Type: application/json" \
  -d '{"query": "–¢–æ–ø-5 –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –≤ –°–ü–±"}'
```

–û—Ç–≤–µ—Ç:
```json
{
  "need_feedback": false,
  "message": "–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é",
  "suggestions": null
}
```

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞

```bash
curl -X POST http://localhost:8000/execute \
  -H "Content-Type: application/json" \
  -d '{"query": "–¢–æ–ø-5 –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ"}'
```

–û—Ç–≤–µ—Ç:
```json
{
  "result": "–ê–Ω–∞–ª–∏–∑ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –≤ –°–ü–±:\n\n1. –ë–æ–ª–µ–∑–Ω–∏ —Å–∏—Å—Ç–µ–º—ã –∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏—è...",
  "charts": ["/charts/plot_uuid.png"]
}
```

## –§–ª–æ—É —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è

```
1. POST /clarify { query: "–ß–µ–º –±–æ–ª–µ—é—Ç?" }
   ‚Üí { need_feedback: true, suggestions: [...] }

2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç

3. POST /execute { query: "–¢–æ–ø-5 –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –≤ –°–ü–±" }
   ‚Üí { result: "...", charts: [...] }
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–∞–ø—Ä–æ—Å —Å—Ä–∞–∑—É –≥–æ—Ç–æ–≤

```
1. POST /clarify { query: "–¢–æ–ø-5 –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –≤ –°–ü–±" }
   ‚Üí { need_feedback: false }

2. POST /execute { query: "–¢–æ–ø-5 –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –≤ –°–ü–±" }
   ‚Üí { result: "...", charts: ["http://localhost:9000/charts/plot_xxx.png"] }
```

## –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –°–µ—Ä–≤–∏—Å—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ   FastAPI    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ  PostgreSQL ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                     ‚îÇ
       ‚îÇ                     ‚ñº
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ    MinIO     ‚îÇ
         (S3 URLs)    ‚îÇ   (Charts)   ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### PostgreSQL (–ø–æ—Ä—Ç 5432)
- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–ø–∞—Ü–∏–µ–Ω—Ç—ã, –¥–∏–∞–≥–Ω–æ–∑—ã, —Ä–µ—Ü–µ–ø—Ç—ã)

#### FastAPI (–ø–æ—Ä—Ç 8000)
- `/clarify` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
- `/execute` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞
- `/health` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- `/charts` - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (fallback)

#### MinIO (–ø–æ—Ä—Ç—ã 9000, 9001)
- **9000** - S3 API –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
- **9001** - Web Console (http://localhost:9001)
- Credentials: `minioadmin` / `minioadmin`

### S3 Integration

–ì—Ä–∞—Ñ–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ MinIO –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–∞–∫ –ø—Ä—è–º—ã–µ S3 URLs:

```json
{
  "result": "–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω",
  "charts": [
    "http://localhost:9000/charts/plot_abc123.png"
  ]
}
```

üìö **–ü–æ–¥—Ä–æ–±–Ω–µ–µ**: —Å–º. [S3_INTEGRATION.md](./S3_INTEGRATION.md)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
fastapi_app/
‚îú‚îÄ‚îÄ main.py              # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ requirements.txt     # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ Dockerfile          # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ test_client_v2.py   # –¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ agent/              # –ê–≥–µ–Ω—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ prompts.py      # –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è LLM
‚îÇ   ‚îú‚îÄ‚îÄ tools.py        # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (SQL, –≥—Ä–∞—Ñ–∏–∫–∏)
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ charts/             # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –≤–µ—Å—å –∫–æ–¥ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ (400 —Å—Ç—Ä–æ–∫)  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - stateless –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞  
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã LLM  
‚úÖ **–ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å** - –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç—å –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å  

## Health Check

```bash
curl http://localhost:8000/health
```

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É:
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
